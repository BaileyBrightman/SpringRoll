/*! SpringRoll 0.4.0 */
!function(){"use strict";!function(){function a(a,b){return a.start-b.start}var b,c,d,e,f=include("createjs.Container"),g=function(a){if(d||(b=include("springroll.Debug",!1),d=include("springroll.Application"),e=include("springroll.Sound"),c=include("springroll.easeljs.BitmapUtils")),f.call(this),!a)throw new Error("need options to create Cutscene");this.isReady=!1,this.framerate=0,this.display="string"==typeof a.display?d.instance.getDisplay(a.display):a.display,this.config=a.configUrl,this.imageScale=a.imageScale||1,this.pathReplaceTarg=a.pathReplaceTarg||null,this.pathReplaceVal=a.pathReplaceVal||null,this._elapsedTime=0,this._audioAliases=null,this._audio=null,this._audioIndex=0,this._audio=null,this._clip=null,this._activeSyncAudio=[],this._soundStartTime=-1,this._activeAudio=[],this._animFinished=!1,this._audioFinished=!1,this._captionsObj=a.captions||null,this._captionsObj&&(this._captionsObj.selfUpdate=!1),this._loadCallback=a.loadCallback||null,this._endCallback=null,this._libItemsToUnload=[],this._imagesToUnload=[],this.update=this.update.bind(this),this.resize=this.resize.bind(this),this.setup()},h=extend(g,f);h.setup=function(){this.display.stage.addChild(this),d.instance.load({id:"config",src:this.config,complete:this.onConfigLoaded.bind(this)},this.onLoadComplete.bind(this))},h.onConfigLoaded=function(b,c){this.config=b.content,this.framerate=this.config.settings.fps;var f={};f.clip=this.config.settings.clip;for(var g in this.config.images)f[g]=this.pathReplaceTarg?this.config.images[g].replace(this.pathReplaceTarg,this.pathReplaceVal):this.config.images[g];if(c.push(function(a){d.instance.load(f,this.onArtLoaded.bind(this,a))}.bind(this)),this.config.settings.audioAlias)this._audioAliases=[this.config.settings.audioAlias],this._audio=[{alias:this.config.settings.audioAlias,start:0,sync:!0}];else{if(!this.config.settings.audio)return;this._audio=this.config.settings.audio.slice(),this._audio.sort(a),this._audioAliases=[];for(var h=0,i=this._audio.length;i>h;++h)-1==this._audioAliases.indexOf(this._audio[h].alias)&&this._audioAliases.push(this._audio[h].alias)}this._audioAliases.length&&e.instance.preload(this._audioAliases,this.onAudioLoaded)},h.onAudioLoaded=function(){},h.onArtLoaded=function(a,b){window.images||(window.images={});var d,e,f,g,h={},i={};for(d in b)if(e=b[d].content,0===d.indexOf("atlasData_"))h[d.replace("atlasData_","")]=e;else if(0===d.indexOf("atlasImage_"))i[d.replace("atlasImage_","")]=e;else if("clip"==d){var j=e.text;if(!j)continue;for(var k=j.split(/[\(!]function\s*\(/),l=0;l<k.length;++l)if(j=k[l]){var m=j.substring(0,j.indexOf(","));if(m)for(var n=new RegExp("\\("+m+".(\\w+)\\s*=","g"),o=n.exec(j);o;)this._libItemsToUnload.push(o[1]),o=n.exec(j)}if(1!=this.imageScale){f=this.imageScale;for(g in this.config.images)c.replaceWithScaledBitmap(g,f)}}else images[d]=e,this._imagesToUnload.push(d);for(d in h)h[d]&&i[d]&&(c.loadSpriteSheet(h[d],i[d],this.imageScale),this._imagesToUnload.push(i[d]));a()},h.onLoadComplete=function(){var a=this._clip=new lib[this.config.settings.clipClass];this._clip.timeline&&1!=this._clip.timeline.duration||(a=this._clip.getChildAt(0)),a.mouseEnabled=!1,a.framerate=this.framerate,a.tickEnabled=!1,a.gotoAndPlay(0),a.loop=!1,this.addChild(this._clip),this.resize(this.display.width,this.display.height),d.instance.on("resize",this.resize),this.isReady=!0,this._loadCallback&&(this._loadCallback(),this._loadCallback=null)},h.resize=function(a,b){if(this._clip){var c,d=this.config.settings,e=d.designedWidth/d.designedHeight,f=a/b;e>f?(c=a/d.designedWidth,this.x=0,this.y=.5*(b-d.designedHeight*c)):(c=b/d.designedHeight,this.x=.5*(a-d.designedWidth*c),this.y=0),this._clip.scaleX=this._clip.scaleY=c}},h.start=function(a){this._endCallback=a,this._elapsedTime=0,this._animFinished=!1,this._audioFinished=!1;for(var b=0;b<this._audio.length;++b){var c=this._audio[b];if(0!==c.start)break;var f=c.alias,g={};if(c.sync){var h=e.instance.play(f,this._audioCallback.bind(this,g));this._activeSyncAudio.unshift(h),g.instance=h,h._audioData=c,this._soundStartTime=c.start,this._captionsObj&&this._captionsObj.play(f)}else{var i=e.instance.play(f,this._audioCallback.bind(this,g));g.instance=i,this._activeAudio.push(i)}++this._audioIndex}d.instance.on("update",this.update)},h._audioCallback=function(a){var b=this._activeSyncAudio.indexOf(a.instance);if(-1!=b)if(0===b?this._activeSyncAudio.shift():this._activeSyncAudio.splice(b,1),this._activeSyncAudio.length<1)this._audioFinished=!0,this._soundStartTime=-1,this._captionsObj&&this._captionsObj.stop(),this._animFinished&&this.stop(!0);else{var c=this._activeSyncAudio[0]._audioData;this._soundStartTime=c.start,this._captionsObj&&this._captionsObj.play(c.alias)}else b=this._activeAudio.indexOf(a.instance),-1!=b&&this._activeAudio.splice(b,1)},h.update=function(a){if(!this._animFinished){this._activeSyncAudio.length||(this._elapsedTime+=.001*a);for(var b=this._audioIndex;b<this._audio.length;++b){var c=this._audio[b];if(!(c.start<=this._elapsedTime))break;var d=c.alias,f={};if(c.sync){this._audioFinished=!1;var g=e.instance.play(d,this._audioCallback.bind(this,f));this._activeSyncAudio.unshift(g),f.instance=g,g._audioData=c,this._soundStartTime=c.start,this._captionsObj&&this._captionsObj.play(d)}else{var h=e.instance.play(d,{complete:this._audioCallback.bind(this,f),offset:1e3*(this._elapsedTime-c.start)});f.instance=h,this._activeAudio.push(h)}++this._audioIndex}if(this._activeSyncAudio.length){var i=.001*this._activeSyncAudio[0].position;0===this._elapsedTime&&i>2*a||(this._elapsedTime=this._soundStartTime+i)}if(this._captionsObj&&this._soundStartTime>=0&&this._captionsObj.seek(this._activeSyncAudio[0].position),!this._animFinished){var j=this._clip.timeline&&1!=this._clip.timeline.duration?this._clip:this._clip.getChildAt(0);j.elapsedTime=this._elapsedTime,j.advance(),j.currentFrame==j.timeline.duration&&(this._animFinished=!0,this._audioFinished&&this.stop(!0))}}},h.stop=function(a){d.instance.off("update",this.update);var b;for(b=0;b<this._activeSyncAudio.length;++b)this._activeSyncAudio[b].stop();for(b=0;b<this._activeAudio.length;++b)this._activeAudio[b].stop();this._captionsObj&&this._captionsObj.stop(),a&&this._endCallback&&(this._endCallback(),this._endCallback=null)},h.destroy=function(){d.instance.off("resize",this.resize),this.removeAllChildren(!0),e.instance.unload(this._audioAliases);var a;for(a=this._libItemsToUnload.length-1;a>=0;--a)delete lib[this._libItemsToUnload[a]];for(a=this._imagesToUnload.length-1;a>=0;--a){var b=this._imagesToUnload[a];"string"==typeof b?(images[b].src="",delete images[b]):b.src=""}this._libItemsToUnload=this._imagesToUnload=this.config=null,this._activeSyncAudio=this._activeAudio=this._audioAliases=this._audio=null,this._loadCallback=this._endCallback=this._clip=this._captionsObj=null,this.parent&&this.parent.removeChild(this),this.display=null},namespace("springroll").Cutscene=g,namespace("springroll.easeljs").Cutscene=g}();}();